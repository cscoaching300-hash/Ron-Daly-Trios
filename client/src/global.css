// client/src/pages/Standings.jsx
import React, { useEffect, useMemo, useState } from 'react'
import { getAuthHeaders } from '../lib/auth.js'

const cell = { padding: 8, borderBottom: '1px solid var(--border)' }
const th = { ...cell, fontWeight: 700 }
const td = cell

export default function Standings() {
  const [league, setLeague] = useState(null)
  const [teamRows, setTeamRows] = useState([])
  const [playerGroups, setPlayerGroups] = useState([]) // [{team:{id,name}, players:[...]}]
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    let cancel = false
    async function load() {
      try {
        setLoading(true)
        const [lgRes, teamRes, pRes] = await Promise.all([
          fetch('/api/leagues', { headers: getAuthHeaders() }),
          fetch('/api/standings', { headers: getAuthHeaders() }),
          fetch('/api/standings/players', { headers: getAuthHeaders() }),
        ])
        const leagues = await lgRes.json()
        const leagueFromToken = leagues[0] || null
        const teams = await teamRes.json()
        const pGroups = await pRes.json()
        if (!cancel) {
          setLeague(leagueFromToken)
          setTeamRows(Array.isArray(teams) ? teams : [])
          setPlayerGroups(Array.isArray(pGroups) ? pGroups : [])
        }
      } finally { if (!cancel) setLoading(false) }
    }
    load()
    return () => { cancel = true }
  }, [])

  // Split player groups into two balanced columns
  const [leftGroups, rightGroups] = useMemo(() => {
    const left = [], right = []
    playerGroups.forEach((g, i) => (i % 2 === 0 ? left : right).push(g))
    return [left, right]
  }, [playerGroups])

  return (
    <div className="card standings-wrap printable" style={{ display:'grid', gap:16 }}>
      {/* Logo centered */}
      <header style={{ textAlign:'center', display:'grid', gap:10 }}>
        {league?.logo ? (
          <img
            src={league.logo}
            alt="League logo"
            style={{ height: 110, objectFit:'contain', margin:'0 auto' }}
          />
        ) : null}
        {/* space for officers if/when you render them */}
        {/* <div className="muted" style={{fontSize:14}}>Chair • Vice Chair • Treasurer • Secretary</div> */}
      </header>

      {/* TEAM STANDINGS (full width) */}
      <section className="card page-break-avoid">
        <h3 style={{ marginTop:0 }}>Team Standings</h3>
        <div style={{ overflowX:'auto' }}>
          <table style={{ width:'100%', borderCollapse:'collapse' }}>
            <thead>
              <tr>
                <th style={th}>Pos</th>
                <th style={th}>Team</th>
                {/* Match player-style order */}
                <th style={th}>Pts</th>
                <th style={th}>PinsS</th>
                <th style={th}>PinsH</th>
                <th style={th}>HGS</th>
                <th style={th}>HGH</th>
                <th style={th}>HSS</th>
                <th style={th}>HSH</th>
              </tr>
            </thead>
            <tbody>
              {teamRows.map(r => (
                <tr key={r.id}>
                  <td style={td}>{r.pos}</td>
                  <td style={td}>{r.name}</td>
                  <td style={{...td, fontWeight:700}}>{r.won}</td>
                  <td style={td}>{r.pinss}</td>
                  <td style={td}>{r.pinsh}</td>
                  <td style={td}>{r.hgs}</td>
                  <td style={td}>{r.hgh}</td>
                  <td style={td}>{r.hss}</td>
                  <td style={td}>{r.hsh}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>

      {/* PLAYER STANDINGS (two columns) */}
      <section className="page-break-avoid">
        <h3 style={{ marginTop:0 }}>Player Standings</h3>

        <div className="standings-columns">
          {/* LEFT COLUMN */}
          <div className="standings-col">
            {leftGroups.map(group => (
              <div key={group.team.id} className="card page-break-avoid">
                <h4 style={{ margin:'4px 0 10px' }}>{group.team.name}</h4>
                <div style={{ overflowX:'auto' }}>
                  <table style={{ width:'100%', borderCollapse:'collapse' }}>
                    <thead>
                      <tr>
                        <th style={th}>Player</th>
                        <th style={th}>Hcp</th>
                        <th style={th}>Ave</th>
                        <th style={th}>Gms</th>
                        <th style={th}>Pts</th>
                        <th style={th}>PinsS</th>
                        <th style={th}>PinsH</th>
                        <th style={th}>HGS</th>
                        <th style={th}>HGH</th>
                        <th style={th}>HSS</th>
                        <th style={th}>HSH</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(group.players || []).map(p => (
                        <tr key={p.player_id}>
                          <td style={td}>{p.name}</td>
                          <td style={td}>{p.hcp}</td>
                          <td style={td}>{p.ave}</td>
                          <td style={td}>{p.gms}</td>
                          <td style={{...td, fontWeight:700}}>{p.pts}</td>
                          <td style={td}>{p.pinss}</td>
                          <td style={td}>{p.pinsh}</td>
                          <td style={td}>{p.hgs}</td>
                          <td style={td}>{p.hgh}</td>
                          <td style={td}>{p.hss}</td>
                          <td style={td}>{p.hsh}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            ))}
          </div>

          {/* RIGHT COLUMN */}
          <div className="standings-col">
            {rightGroups.map(group => (
              <div key={group.team.id} className="card page-break-avoid">
                <h4 style={{ margin:'4px 0 10px' }}>{group.team.name}</h4>
                <div style={{ overflowX:'auto' }}>
                  <table style={{ width:'100%', borderCollapse:'collapse' }}>
                    <thead>
                      <tr>
                        <th style={th}>Player</th>
                        <th style={th}>Hcp</th>
                        <th style={th}>Ave</th>
                        <th style={th}>Gms</th>
                        <th style={th}>Pts</th>
                        <th style={th}>PinsS</th>
                        <th style={th}>PinsH</th>
                        <th style={th}>HGS</th>
                        <th style={th}>HGH</th>
                        <th style={th}>HSS</th>
                        <th style={th}>HSH</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(group.players || []).map(p => (
                        <tr key={p.player_id}>
                          <td style={td}>{p.name}</td>
                          <td style={td}>{p.hcp}</td>
                          <td style={td}>{p.ave}</td>
                          <td style={td}>{p.gms}</td>
                          <td style={{...td, fontWeight:700}}>{p.pts}</td>
                          <td style={td}>{p.pinss}</td>
                          <td style={td}>{p.pinsh}</td>
                          <td style={td}>{p.hgs}</td>
                          <td style={td}>{p.hgh}</td>
                          <td style={td}>{p.hss}</td>
                          <td style={td}>{p.hsh}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* Export (hidden on print) */}
      <div className="no-print" style={{ display:'flex', justifyContent:'flex-end' }}>
        <button className="button" onClick={()=>window.print()}>Export PDF</button>
      </div>

      {loading && <div className="muted">Loading…</div>}
    </div>
  )
}
